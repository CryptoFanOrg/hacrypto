<html>
<head>
<!--
     Copyright (c) 1998-2014 The OpenSSL Project, http://www.openssl.org/
     Author:   OpenSSL (openssl@openssl.org)
     Modified: 2013-06-13 14:00:12.
     Generated from ``BIO_f_ssl.wml'' via WML 2.0.11 (19-Aug-2006).
               by OpenSSL (openssl@openssl.org)
               on 2014-05-01 12:12:38.

     DO NOT EDIT THIS FILE DIRECTLY! INSTEAD EDIT ``BIO_f_ssl.wml''.
-->
<meta name="Copyright" content="1998-2014 The OpenSSL Project, http://www.openssl.org/">
<meta name="Author"    content="OpenSSL, openssl@openssl.org">
<meta name="Generator" content="WML 2.0.11 (19-Aug-2006)">
<meta name="Modified"  content="2013-06-13 14:00:12">
<title>OpenSSL: Documents, BIO_f_ssl(3)</title>
<style type="text/css"><!--
BODY { position: absolute; left: 0px; top: 0px; background: #666699; }
A { text-decoration: none; font-weight: bold; }
A:link { text-decoration: none; font-weight: bold; color: #666699; }
A:visited { text-decoration: none; font-weight: bold; color: #666699; }
A:hover { text-decoration: none; font-weight: bold; color: #666699; text-decoration: underline; }
#red { color: #cc3333; }
#sf { font-family: arial,helvetica; font-variant: normal; font-style: normal; }
#sfl { font-weight: bold; font-family: arial,helvetica; font-size: 16pt; line-height: 16pt; font-variant: normal; font-style: normal; }
H1 { font-weight: bold; font-size: 18pt; line-height: 18pt; font-family: arial,helvetica; font-variant: normal; font-style: normal; }
H2 { font-weight: bold; font-size: 14pt; line-height: 14pt; font-family: arial,helvetica; font-variant: normal; font-style: normal; }
H3 { font-weight: bold; font-size: 12pt; line-height: 12pt; font-family: arial,helvetica; font-variant: normal; font-style: normal; }
--></style>
</head>
<body link="#6666cc" alink="#6666cc" vlink="#6666cc" bgcolor="#666699" text="#000000"
      marginheight="0" leftmargin="0" rightmargin="0" topmargin="0">
<table width="100%" cellspacing="0" cellpadding="0" border="0" summary="">
  <tr><td align="left" width="100" bgcolor="#666699"><img src="../../images/page-head-tl.jpg" alt="OpenSSL" width="100" height="80"></td><td align="left" colspan="2" width="600" bgcolor="#666699"><img src="../../images/page-head-tm.jpg" alt="" width="600" height="80"></td><td align="right" width="20" bgcolor="#666699">&nbsp;&nbsp;&nbsp;</td><td align="right" width="50" bgcolor="#666699">&nbsp;</td></tr>
  <tr><td align="left" width="100"><img src="../../images/page-head-bl.jpg" alt="" width="100" height="20"></td><td align="left" width="20"><img src="../../images/page-head-bm.jpg" alt="" width="20" height="20"></td><td align="left" width="100%" bgcolor="#ffffff">
<table cellspacing="0" cellpadding="0" border="0" summary="">
        <tr>
<td><font face="Arial,Helvetica">&nbsp;<a href="../index.html" onmouseover="self.status = '../'; return true" onmouseout="self.status = ''; return true" onfocus="self.status = '../'; return true" onblur="self.status = ''; return true"><font color="#666666">Documents</font></a></font>&nbsp;</td><td>|</td>
<td><font face="Arial,Helvetica">&nbsp;<a href="../apps/openssl.html" onmouseover="self.status = '../apps/openssl.html'; return true" onmouseout="self.status = ''; return true" onfocus="self.status = '../apps/openssl.html'; return true" onblur="self.status = ''; return true"><font color="#666666">openssl(1)</font></a></font>&nbsp;</td><td>|</td>
<td><font face="Arial,Helvetica">&nbsp;<a href="../ssl/ssl.html" onmouseover="self.status = '../ssl/ssl.html'; return true" onmouseout="self.status = ''; return true" onfocus="self.status = '../ssl/ssl.html'; return true" onblur="self.status = ''; return true"><font color="#666666">ssl(3)</font></a></font>&nbsp;</td><td>|</td>
<td><font face="Arial,Helvetica">&nbsp;<a href="crypto.html" onmouseover="self.status = '../crypto/crypto.html'; return true" onmouseout="self.status = ''; return true" onfocus="self.status = '../crypto/crypto.html'; return true" onblur="self.status = ''; return true"><font color="#666666">crypto(3)</font></a></font>&nbsp;</td><td>|</td>
<td><font face="Arial,Helvetica">&nbsp;<a href="../HOWTO/index.html" onmouseover="self.status = '../HOWTO/'; return true" onmouseout="self.status = ''; return true" onfocus="self.status = '../HOWTO/'; return true" onblur="self.status = ''; return true"><font color="#666666">HOWTO</font></a></font>&nbsp;</td><td>|</td>
<td><font face="Arial,Helvetica">&nbsp;<a href="http://wiki.openssl.org/" onmouseover="self.status = 'http://wiki.openssl.org/'; return true" onmouseout="self.status = ''; return true" onfocus="self.status = 'http://wiki.openssl.org/'; return true" onblur="self.status = ''; return true"><font color="#666666">Wiki</font></a></font>&nbsp;</td><td>|</td>
<td><font face="Arial,Helvetica">&nbsp;<a href="../fips/index.html" onmouseover="self.status = '../fips/'; return true" onmouseout="self.status = ''; return true" onfocus="self.status = '../fips/'; return true" onblur="self.status = ''; return true"><font color="#666666">FIPS140</font></a></font>&nbsp;</td><td>|</td>
<td><font face="Arial,Helvetica">&nbsp;<a href="../misc/index.html" onmouseover="self.status = '../misc/'; return true" onmouseout="self.status = ''; return true" onfocus="self.status = '../misc/'; return true" onblur="self.status = ''; return true"><font color="#666666">misc</font></a></font>&nbsp;</td><td></td>
</tr>
      </table>
</td><td align="right" width="20"><img src="../../images/page-corner-tr.gif" alt="" width="20" height="20"></td><td align="right" width="50" bgcolor="#666699">&nbsp;</td></tr>
  <tr><td align="left" valign="top" width="100" bgcolor="#666699"><table cellspacing="0" cellpadding="0" border="0" summary=""><tr><td><img src="../../images/page-navbar-top.jpg" alt="" width="100" height="11"></td></tr>
<script type="text/javascript" language="JavaScript">
<!-- Hiding the code
function nb_imgNormal(imgName) {
    if (document.images) {
        document[imgName].src = eval(imgName + '_n.src');
        self.status = '';
    }
}
function nb_imgSelect(imgName) {
    if (document.images) {
        document[imgName].src = eval(imgName + '_s.src');
        self.status = '';
    }
}
function nb_imgOver(imgName, nohints, descript) {
    if (document.images) {
        document[imgName].src = eval(imgName + '_o.src');
        if (! nohints) self.status = descript;
    }
}
// done hiding -->
</script>
<script type="text/javascript" language="JavaScript">
<!-- Hiding the code
if (document.images) {
    nb_img1_title_n = new Image();
    nb_img1_title_n.src = '../../images/page-navbar-ti-n.jpg';
    nb_img1_title_o = new Image();
    nb_img1_title_o.src = '../../images/page-navbar-ti-s.jpg';
    nb_img1_FAQ_n = new Image();
    nb_img1_FAQ_n.src = '../../images/page-navbar-fq-n.jpg';
    nb_img1_FAQ_o = new Image();
    nb_img1_FAQ_o.src = '../../images/page-navbar-fq-s.jpg';
    nb_img1_about_n = new Image();
    nb_img1_about_n.src = '../../images/page-navbar-ab-n.jpg';
    nb_img1_about_o = new Image();
    nb_img1_about_o.src = '../../images/page-navbar-ab-s.jpg';
    nb_img1_news_n = new Image();
    nb_img1_news_n.src = '../../images/page-navbar-ne-n.jpg';
    nb_img1_news_o = new Image();
    nb_img1_news_o.src = '../../images/page-navbar-ne-s.jpg';
    nb_img1_docs_s = new Image();
    nb_img1_docs_s.src = '../../images/page-navbar-do-s.jpg';
    nb_img1_docs_o = new Image();
    nb_img1_docs_o.src = '../../images/page-navbar-do-s.jpg';
    nb_img1_source_n = new Image();
    nb_img1_source_n.src = '../../images/page-navbar-so-n.jpg';
    nb_img1_source_o = new Image();
    nb_img1_source_o.src = '../../images/page-navbar-so-s.jpg';
    nb_img1_contrib_n = new Image();
    nb_img1_contrib_n.src = '../../images/page-navbar-co-n.jpg';
    nb_img1_contrib_o = new Image();
    nb_img1_contrib_o.src = '../../images/page-navbar-co-s.jpg';
    nb_img1_support_n = new Image();
    nb_img1_support_n.src = '../../images/page-navbar-su-n.jpg';
    nb_img1_support_o = new Image();
    nb_img1_support_o.src = '../../images/page-navbar-su-s.jpg';
    nb_img1_related_n = new Image();
    nb_img1_related_n.src = '../../images/page-navbar-re-n.jpg';
    nb_img1_related_o = new Image();
    nb_img1_related_o.src = '../../images/page-navbar-re-s.jpg';
}
// done hiding -->
</script>
<tr><td><a href="../../index.html" onmouseover="nb_imgOver('nb_img1_title', 0, 'Title'); return true" onmouseout="nb_imgNormal('nb_img1_title'); return true" onfocus="nb_imgOver('nb_img1_title', 0, 'Title'); return true" onblur="nb_imgNormal('nb_img1_title'); return true"><img name="nb_img1_title" src="../../images/page-navbar-ti-n.jpg" alt="Title" border="0" width="100" height="27"></a></td></tr>
<tr><td><a href="../../support/faq.html" onmouseover="nb_imgOver('nb_img1_FAQ', 0, 'FAQ'); return true" onmouseout="nb_imgNormal('nb_img1_FAQ'); return true" onfocus="nb_imgOver('nb_img1_FAQ', 0, 'FAQ'); return true" onblur="nb_imgNormal('nb_img1_FAQ'); return true"><img name="nb_img1_FAQ" src="../../images/page-navbar-fq-n.jpg" alt="FAQ" border="0" width="100" height="27"></a></td></tr>
<tr><td><a href="../../about/index.html" onmouseover="nb_imgOver('nb_img1_about', 0, 'About'); return true" onmouseout="nb_imgNormal('nb_img1_about'); return true" onfocus="nb_imgOver('nb_img1_about', 0, 'About'); return true" onblur="nb_imgNormal('nb_img1_about'); return true"><img name="nb_img1_about" src="../../images/page-navbar-ab-n.jpg" alt="About" border="0" width="100" height="27"></a></td></tr>
<tr><td><a href="../../news/index.html" onmouseover="nb_imgOver('nb_img1_news', 0, 'News'); return true" onmouseout="nb_imgNormal('nb_img1_news'); return true" onfocus="nb_imgOver('nb_img1_news', 0, 'News'); return true" onblur="nb_imgNormal('nb_img1_news'); return true"><img name="nb_img1_news" src="../../images/page-navbar-ne-n.jpg" alt="News" border="0" width="100" height="27"></a></td></tr>
<tr><td><a href="../index.html" onmouseover="nb_imgOver('nb_img1_docs', 0, 'Documents'); return true" onmouseout="nb_imgSelect('nb_img1_docs'); return true" onfocus="nb_imgOver('nb_img1_docs', 0, 'Documents'); return true" onblur="nb_imgSelect('nb_img1_docs'); return true"><img name="nb_img1_docs" src="../../images/page-navbar-do-s.jpg" alt="Documents" border="0" width="100" height="27"></a></td></tr>
<tr><td><a href="../../source/index.html" onmouseover="nb_imgOver('nb_img1_source', 0, 'Source'); return true" onmouseout="nb_imgNormal('nb_img1_source'); return true" onfocus="nb_imgOver('nb_img1_source', 0, 'Source'); return true" onblur="nb_imgNormal('nb_img1_source'); return true"><img name="nb_img1_source" src="../../images/page-navbar-so-n.jpg" alt="Source" border="0" width="100" height="27"></a></td></tr>
<tr><td><a href="../../contrib/index.html" onmouseover="nb_imgOver('nb_img1_contrib', 0, 'Contribution'); return true" onmouseout="nb_imgNormal('nb_img1_contrib'); return true" onfocus="nb_imgOver('nb_img1_contrib', 0, 'Contribution'); return true" onblur="nb_imgNormal('nb_img1_contrib'); return true"><img name="nb_img1_contrib" src="../../images/page-navbar-co-n.jpg" alt="Contribution" border="0" width="100" height="27"></a></td></tr>
<tr><td><a href="../../support/index.html" onmouseover="nb_imgOver('nb_img1_support', 0, 'Support'); return true" onmouseout="nb_imgNormal('nb_img1_support'); return true" onfocus="nb_imgOver('nb_img1_support', 0, 'Support'); return true" onblur="nb_imgNormal('nb_img1_support'); return true"><img name="nb_img1_support" src="../../images/page-navbar-su-n.jpg" alt="Support" border="0" width="100" height="27"></a></td></tr>
<tr><td><a href="../../related/index.html" onmouseover="nb_imgOver('nb_img1_related', 0, 'Related'); return true" onmouseout="nb_imgNormal('nb_img1_related'); return true" onfocus="nb_imgOver('nb_img1_related', 0, 'Related'); return true" onblur="nb_imgNormal('nb_img1_related'); return true"><img name="nb_img1_related" src="../../images/page-navbar-re-n.jpg" alt="Related" border="0" width="100" height="27"></a></td></tr>
    <tr><td><img src="../../images/page-navbar-bot.jpg" alt="" width="100" height="150"><br><p></td></tr>
  </table>
</td><td align="left" valign="top" width="20" bgcolor="#ffffff">&nbsp;</td><td align="left" valign="top" bgcolor="#ffffff"><br>
        
<h1>BIO_f_ssl(3)</h1>
<!-- INDEX BEGIN -->
<UL>
	<LI><A HREF="BIO_f_ssl.html#NAME">NAME</A>
	<LI><A HREF="BIO_f_ssl.html#SYNOPSIS">SYNOPSIS</A>
	<LI><A HREF="BIO_f_ssl.html#DESCRIPTION">DESCRIPTION</A>
	<LI><A HREF="BIO_f_ssl.html#NOTES">NOTES</A>
	<LI><A HREF="BIO_f_ssl.html#RETURN_VALUES">RETURN VALUES</A>
	<LI><A HREF="BIO_f_ssl.html#EXAMPLE">EXAMPLE</A>
	<LI><A HREF="BIO_f_ssl.html#BUGS">BUGS</A>
	<LI><A HREF="BIO_f_ssl.html#SEE_ALSO">SEE ALSO</A>
</UL>
<!-- INDEX END -->
<HR>
<P>
<HR>
<H1><A NAME="NAME">NAME</A></H1>
<P>
BIO_f_ssl, BIO_set_ssl, BIO_get_ssl, BIO_set_ssl_mode,
BIO_set_ssl_renegotiate_bytes, BIO_get_num_renegotiates,
BIO_set_ssl_renegotiate_timeout, BIO_new_ssl, BIO_new_ssl_connect,
BIO_new_buffer_ssl_connect, BIO_ssl_copy_session_id, BIO_ssl_shutdown - SSL
BIO
</P>
<P>
<HR>
<H1><A NAME="SYNOPSIS">SYNOPSIS</A></H1>
<PRE> #include &lt;openssl/bio.h&gt;
 #include &lt;openssl/ssl.h&gt;
</PRE>
<PRE> BIO_METHOD *BIO_f_ssl(void);
</PRE>
<PRE> #define BIO_set_ssl(b,ssl,c)   BIO_ctrl(b,BIO_C_SET_SSL,c,(char *)ssl)
 #define BIO_get_ssl(b,sslp)    BIO_ctrl(b,BIO_C_GET_SSL,0,(char *)sslp)
 #define BIO_set_ssl_mode(b,client)     BIO_ctrl(b,BIO_C_SSL_MODE,client,NULL)
 #define BIO_set_ssl_renegotiate_bytes(b,num) \
        BIO_ctrl(b,BIO_C_SET_SSL_RENEGOTIATE_BYTES,num,NULL);
 #define BIO_set_ssl_renegotiate_timeout(b,seconds) \
        BIO_ctrl(b,BIO_C_SET_SSL_RENEGOTIATE_TIMEOUT,seconds,NULL);
 #define BIO_get_num_renegotiates(b) \
        BIO_ctrl(b,BIO_C_SET_SSL_NUM_RENEGOTIATES,0,NULL);
</PRE>
<PRE> BIO *BIO_new_ssl(SSL_CTX *ctx,int client);
 BIO *BIO_new_ssl_connect(SSL_CTX *ctx);
 BIO *BIO_new_buffer_ssl_connect(SSL_CTX *ctx);
 int BIO_ssl_copy_session_id(BIO *to,BIO *from);
 void BIO_ssl_shutdown(BIO *bio);
</PRE>
<PRE> #define BIO_do_handshake(b)    BIO_ctrl(b,BIO_C_DO_STATE_MACHINE,0,NULL)
</PRE>
<P>
<HR>
<H1><A NAME="DESCRIPTION">DESCRIPTION</A></H1>
<P>
<CODE>BIO_f_ssl()</CODE> returns the SSL BIO method. This is a filter BIO
which is a wrapper round the OpenSSL SSL routines adding a BIO ``flavour''
to SSL I/O.
</P>
<P>
I/O performed on an SSL BIO communicates using the SSL protocol with the
SSLs read and write BIOs. If an SSL connection is not established then an
attempt is made to establish one on the first I/O call.
</P>
<P>
If a BIO is appended to an SSL BIO using <CODE>BIO_push()</CODE> it is
automatically used as the SSL BIOs read and write BIOs.
</P>
<P>
Calling <CODE>BIO_reset()</CODE> on an SSL BIO closes down any current SSL
connection by calling <CODE>SSL_shutdown().</CODE> <CODE>BIO_reset()</CODE>
is then sent to the next BIO in the chain: this will typically disconnect
the underlying transport. The SSL BIO is then reset to the initial accept
or connect state.
</P>
<P>
If the close flag is set when an SSL BIO is freed then the internal SSL
structure is also freed using <CODE>SSL_free().</CODE>
</P>
<P>
<CODE>BIO_set_ssl()</CODE> sets the internal SSL pointer of BIO <STRONG>b</STRONG> to <STRONG>ssl</STRONG> using the close flag <STRONG>c</STRONG>.
</P>
<P>
<CODE>BIO_get_ssl()</CODE> retrieves the SSL pointer of BIO <STRONG>b</STRONG>, it can then be manipulated using the standard SSL library functions.
</P>
<P>
<CODE>BIO_set_ssl_mode()</CODE> sets the SSL BIO mode to <STRONG>client</STRONG>. If <STRONG>client</STRONG>
is 1 client mode is set. If <STRONG>client</STRONG> is 0 server mode is set.
</P>
<P>
<CODE>BIO_set_ssl_renegotiate_bytes()</CODE> sets the renegotiate byte
count to <STRONG>num</STRONG>. When set after every <STRONG>num</STRONG> bytes of I/O (read and write) the SSL session is automatically
renegotiated. <STRONG>num</STRONG> must be at least 512 bytes.
</P>
<P>
<CODE>BIO_set_ssl_renegotiate_timeout()</CODE> sets the renegotiate timeout
to
<STRONG>seconds</STRONG>. When the renegotiate timeout elapses the session is automatically
renegotiated.
</P>
<P>
<CODE>BIO_get_num_renegotiates()</CODE> returns the total number of session
renegotiations due to I/O or timeout.
</P>
<P>
<CODE>BIO_new_ssl()</CODE> allocates an SSL BIO using SSL_CTX <STRONG>ctx</STRONG> and using client mode if <STRONG>client</STRONG> is non zero.
</P>
<P>
<CODE>BIO_new_ssl_connect()</CODE> creates a new BIO chain consisting of an
SSL BIO (using <STRONG>ctx</STRONG>) followed by a connect BIO.
</P>
<P>
<CODE>BIO_new_buffer_ssl_connect()</CODE> creates a new BIO chain
consisting of a buffering BIO, an SSL BIO (using <STRONG>ctx</STRONG>) and a connect BIO.
</P>
<P>
<CODE>BIO_ssl_copy_session_id()</CODE> copies an SSL session id between BIO
chains <STRONG>from</STRONG> and <STRONG>to</STRONG>. It does this by locating the SSL BIOs in each chain and calling
<CODE>SSL_copy_session_id()</CODE> on the internal SSL pointer.
</P>
<P>
<CODE>BIO_ssl_shutdown()</CODE> closes down an SSL connection on BIO chain <STRONG>bio</STRONG>. It does this by locating the SSL BIO in the chain and calling
<CODE>SSL_shutdown()</CODE> on its internal SSL pointer.
</P>
<P>
<CODE>BIO_do_handshake()</CODE> attempts to complete an SSL handshake on
the supplied BIO and establish the SSL connection. It returns 1 if the
connection was established successfully. A zero or negative value is
returned if the connection could not be established, the call
<CODE>BIO_should_retry()</CODE> should be used for non blocking connect
BIOs to determine if the call should be retried. If an SSL connection has
already been established this call has no effect.
</P>
<P>
<HR>
<H1><A NAME="NOTES">NOTES</A></H1>
<P>
SSL BIOs are exceptional in that if the underlying transport is non
blocking they can still request a retry in exceptional circumstances.
Specifically this will happen if a session renegotiation takes place during
a <CODE>BIO_read()</CODE> operation, one case where this happens is when
SGC or step up occurs.
</P>
<P>
In OpenSSL 0.9.6 and later the SSL flag SSL_AUTO_RETRY can be set to
disable this behaviour. That is when this flag is set an SSL BIO using a
blocking transport will never request a retry.
</P>
<P>
Since unknown <CODE>BIO_ctrl()</CODE> operations are sent through filter
BIOs the servers name and port can be set using <CODE>BIO_set_host()</CODE>
on the BIO returned by <CODE>BIO_new_ssl_connect()</CODE> without having to
locate the connect BIO first.
</P>
<P>
Applications do not have to call <CODE>BIO_do_handshake()</CODE> but may
wish to do so to separate the handshake process from other I/O processing.
</P>
<P>
<HR>
<H1><A NAME="RETURN_VALUES">RETURN VALUES</A></H1>
<P>
TBA
</P>
<P>
<HR>
<H1><A NAME="EXAMPLE">EXAMPLE</A></H1>
<P>
This SSL/TLS client example, attempts to retrieve a page from an SSL/TLS
web server. The I/O routines are identical to those of the unencrypted
example in <A HREF="BIO_s_connect.html#">BIO_s_connect(3)</A>.
</P>
<PRE> BIO *sbio, *out;
 int len;
 char tmpbuf&#91;1024&#93;;
 SSL_CTX *ctx;
 SSL *ssl;
</PRE>
<PRE> ERR_load_crypto_strings();
 ERR_load_SSL_strings();
 OpenSSL_add_all_algorithms();
</PRE>
<PRE> /* We would seed the PRNG here if the platform didn't
  * do it automatically
  */
</PRE>
<PRE> ctx = SSL_CTX_new(SSLv23_client_method());
</PRE>
<PRE> /* We'd normally set some stuff like the verify paths and
  * mode here because as things stand this will connect to
  * any server whose certificate is signed by any CA.
  */
</PRE>
<PRE> sbio = BIO_new_ssl_connect(ctx);
</PRE>
<PRE> BIO_get_ssl(sbio, &amp;ssl);
</PRE>
<PRE> if(!ssl) {
   fprintf(stderr, &quot;Can't locate SSL pointer\n&quot;);
   /* whatever ... */
 }
</PRE>
<PRE> /* Don't want any retries */
 SSL_set_mode(ssl, SSL_MODE_AUTO_RETRY);
</PRE>
<PRE> /* We might want to do other things with ssl here */
</PRE>
<PRE> BIO_set_conn_hostname(sbio, &quot;localhost:https&quot;);
</PRE>
<PRE> out = BIO_new_fp(stdout, BIO_NOCLOSE);
 if(BIO_do_connect(sbio) &lt;= 0) {
        fprintf(stderr, &quot;Error connecting to server\n&quot;);
        ERR_print_errors_fp(stderr);
        /* whatever ... */
 }
</PRE>
<PRE> if(BIO_do_handshake(sbio) &lt;= 0) {
        fprintf(stderr, &quot;Error establishing SSL connection\n&quot;);
        ERR_print_errors_fp(stderr);
        /* whatever ... */
 }
</PRE>
<PRE> /* Could examine ssl here to get connection info */
</PRE>
<PRE> BIO_puts(sbio, &quot;GET / HTTP/1.0\n\n&quot;);
 for(;;) {
        len = BIO_read(sbio, tmpbuf, 1024);
        if(len &lt;= 0) break;
        BIO_write(out, tmpbuf, len);
 }
 BIO_free_all(sbio);
 BIO_free(out);
</PRE>
<P>
Here is a simple server example. It makes use of a buffering BIO to allow
lines to be read from the SSL BIO using BIO_gets. It creates a pseudo web
page containing the actual request from a client and also echoes the
request to standard output.
</P>
<PRE> BIO *sbio, *bbio, *acpt, *out;
 int len;
 char tmpbuf&#91;1024&#93;;
 SSL_CTX *ctx;
 SSL *ssl;
</PRE>
<PRE> ERR_load_crypto_strings();
 ERR_load_SSL_strings();
 OpenSSL_add_all_algorithms();
</PRE>
<PRE> /* Might seed PRNG here */
</PRE>
<PRE> ctx = SSL_CTX_new(SSLv23_server_method());
</PRE>
<PRE> if (!SSL_CTX_use_certificate_file(ctx,&quot;server.pem&quot;,SSL_FILETYPE_PEM)
        || !SSL_CTX_use_PrivateKey_file(ctx,&quot;server.pem&quot;,SSL_FILETYPE_PEM)
        || !SSL_CTX_check_private_key(ctx)) {
</PRE>
<PRE>        fprintf(stderr, &quot;Error setting up SSL_CTX\n&quot;);
        ERR_print_errors_fp(stderr);
        return 0;
 }
</PRE>
<PRE> /* Might do other things here like setting verify locations and
  * DH and/or RSA temporary key callbacks
  */
</PRE>
<PRE> /* New SSL BIO setup as server */
 sbio=BIO_new_ssl(ctx,0);
</PRE>
<PRE> BIO_get_ssl(sbio, &amp;ssl);
</PRE>
<PRE> if(!ssl) {
   fprintf(stderr, &quot;Can't locate SSL pointer\n&quot;);
   /* whatever ... */
 }
</PRE>
<PRE> /* Don't want any retries */
 SSL_set_mode(ssl, SSL_MODE_AUTO_RETRY);
</PRE>
<PRE> /* Create the buffering BIO */
</PRE>
<PRE> bbio = BIO_new(BIO_f_buffer());
</PRE>
<PRE> /* Add to chain */
 sbio = BIO_push(bbio, sbio);
</PRE>
<PRE> acpt=BIO_new_accept(&quot;4433&quot;);
</PRE>
<PRE> /* By doing this when a new connection is established
  * we automatically have sbio inserted into it. The
  * BIO chain is now 'swallowed' by the accept BIO and
  * will be freed when the accept BIO is freed.
  */
 
 BIO_set_accept_bios(acpt,sbio);
</PRE>
<PRE> out = BIO_new_fp(stdout, BIO_NOCLOSE);
</PRE>
<PRE> /* Setup accept BIO */
 if(BIO_do_accept(acpt) &lt;= 0) {
        fprintf(stderr, &quot;Error setting up accept BIO\n&quot;);
        ERR_print_errors_fp(stderr);
        return 0;
 }
</PRE>
<PRE> /* Now wait for incoming connection */
 if(BIO_do_accept(acpt) &lt;= 0) {
        fprintf(stderr, &quot;Error in connection\n&quot;);
        ERR_print_errors_fp(stderr);
        return 0;
 }
</PRE>
<PRE> /* We only want one connection so remove and free
  * accept BIO
  */
</PRE>
<PRE> sbio = BIO_pop(acpt);
</PRE>
<PRE> BIO_free_all(acpt);
</PRE>
<PRE> if(BIO_do_handshake(sbio) &lt;= 0) {
        fprintf(stderr, &quot;Error in SSL handshake\n&quot;);
        ERR_print_errors_fp(stderr);
        return 0;
 }
</PRE>
<PRE> BIO_puts(sbio, &quot;HTTP/1.0 200 OK\r\nContent-type: text/plain\r\n\r\n&quot;);
 BIO_puts(sbio, &quot;\r\nConnection Established\r\nRequest headers:\r\n&quot;);
 BIO_puts(sbio, &quot;--------------------------------------------------\r\n&quot;);
</PRE>
<PRE> for(;;) {
        len = BIO_gets(sbio, tmpbuf, 1024);
        if(len &lt;= 0) break;
        BIO_write(sbio, tmpbuf, len);
        BIO_write(out, tmpbuf, len);
        /* Look for blank line signifying end of headers*/
        if((tmpbuf&#91;0&#93; == '\r') || (tmpbuf&#91;0&#93; == '\n')) break;
 }
</PRE>
<PRE> BIO_puts(sbio, &quot;--------------------------------------------------\r\n&quot;);
 BIO_puts(sbio, &quot;\r\n&quot;);
</PRE>
<PRE> /* Since there is a buffering BIO present we had better flush it */
 BIO_flush(sbio);
</PRE>
<PRE> BIO_free_all(sbio);
</PRE>
<P>
<HR>
<H1><A NAME="BUGS">BUGS</A></H1>
<P>
In OpenSSL versions before 1.0.0 the <CODE>BIO_pop()</CODE> call was
handled incorrectly, the I/O BIO reference count was incorrectly
incremented (instead of decremented) and dissociated with the SSL BIO even
if the SSL BIO was not explicitly being popped (e.g. a pop higher up the
chain). Applications which included workarounds for this bug (e.g. freeing
BIOs more than once) should be modified to handle this fix or they may free
up an already freed BIO.
</P>
<P>
<HR>
<H1><A NAME="SEE_ALSO">SEE ALSO</A></H1>
<P>
TBA
</P>
        </td><td align="right" width="20" bgcolor="#ffffff">&nbsp;&nbsp;&nbsp;</td><td align="right" width="50" bgcolor="#666699">&nbsp;</td></tr>
  <tr><td align="left" valign="top" width="100" bgcolor="#666699">&nbsp;</td><td align="left" width="20"><img src="../../images/page-corner-bl.gif" alt="" width="20" height="20"></td><td align="left" valign="top" bgcolor="#ffffff">&nbsp;</td><td align="right" width="20"><img src="../../images/page-corner-br.gif" alt="" width="20" height="20"></td><td align="right" width="50" bgcolor="#666699">&nbsp;</td></tr>
  <tr><td colspan="5" bgcolor="#666699">&nbsp;</td></tr>
</table>
</body>
</html>

